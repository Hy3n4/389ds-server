---
- name: Enable/disable plugins
  ldap_attr:
    server_uri: "ldap:///localhost"
    bind_dn: "{{ rootdn }}"
    bind_pw: "{{ rootdn_password }}"
    dn: "cn={{ item.key }},cn=plugins,cn=config"
    name: nsslapd-pluginEnabled
    values: "{{ 'on' if item.value.enabled else 'off' }}"
    state: exact
  loop: "{{ plugins|dict2items }}"

# TODO: make this "UID numbers/GID numbers" generic
- name: Remove DNA plugin configuration (if disabled)
  ldap_entry:
    server_uri: "ldap:///localhost"
    bind_dn: "{{ rootdn }}"
    bind_pw: "{{ rootdn_password }}"
    dn: "{{ item }}"
    state: absent
  loop:
  - "cn=UID numbers,cn=Distributed Numeric Assignment Plugin,cn=plugins,cn=config"
  - "cn=GID numbers,cn=Distributed Numeric Assignment Plugin,cn=plugins,cn=config"
  when: not plugins["Distributed Numeric Assignment Plugin"].enabled
  notify: dirsrv restart

- name: Create DNA plugin configuration (if enabled)
  ldap_entry:
    server_uri: "ldap:///localhost"
    bind_dn: "{{ rootdn }}"
    bind_pw: "{{ rootdn_password }}"
    dn: "{{ item }}"
    objectClass:
      - top
      - extensibleObject
    state: present
  loop:
  - "cn=UID numbers,cn=Distributed Numeric Assignment Plugin,cn=plugins,cn=config"
  - "cn=GID numbers,cn=Distributed Numeric Assignment Plugin,cn=plugins,cn=config"
  when: plugins["Distributed Numeric Assignment Plugin"].enabled
  notify: dirsrv restart

- name: Configure DNA plugin parameters (UID)
  ldap_attr:
    server_uri: "ldap:///localhost"
    bind_dn: "{{ rootdn }}"
    bind_pw: "{{ rootdn_password }}"
    dn: "cn=UID numbers,cn=Distributed Numeric Assignment Plugin,cn=plugins,cn=config"
    name: "{{ item.name }}"
    values: "{{ item.value }}"
    state: exact
  loop:
  - { name: "cn", value: "UID numbers" }
  - { name: "dnatype", value: "uidNumber" }
  - { name: "dnamagicregen", value: "magic" } # doesn't have to be a number
  - { name: "dnafilter", value: "(objectclass=posixAccount)" }
  - { name: "dnascope", value: "{{ suffix }}" }
  - { name: "dnanextvalue", value: "{{ plugins['Distributed Numeric Assignment Plugin'].uid_min }}" }
  - { name: "dnamaxvalue", value: "{{ plugins['Distributed Numeric Assignment Plugin'].uid_max }}" }
  when: plugins["Distributed Numeric Assignment Plugin"].enabled
  notify: dirsrv restart

- name: Configure DNA plugin parameters (GID)
  ldap_attr:
    server_uri: "ldap:///localhost"
    bind_dn: "{{ rootdn }}"
    bind_pw: "{{ rootdn_password }}"
    dn: "cn=GID numbers,cn=Distributed Numeric Assignment Plugin,cn=plugins,cn=config"
    name: "{{ item.name }}"
    values: "{{ item.value }}"
    state: exact
  loop:
  - { name: "cn", value: "GID numbers" }
  - { name: "dnatype", value: "gidNumber" }
  - { name: "dnamagicregen", value: "magic" }
  - { name: "dnafilter", value: "(objectclass=posixAccount)" }
  - { name: "dnascope", value: "{{ suffix }}" }
  - { name: "dnanextvalue", value: "{{ plugins['Distributed Numeric Assignment Plugin'].gid_min }}" }
  - { name: "dnamaxvalue", value: "{{ plugins['Distributed Numeric Assignment Plugin'].gid_max }}" }
  when: plugins["Distributed Numeric Assignment Plugin"].enabled
  notify: dirsrv restart
